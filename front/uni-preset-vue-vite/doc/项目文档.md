# 云日记｜项目文档（简明版）

更新日期：2025-10-13

## 概述

云日记是一个基于 Uniapp + Vue 3 的移动端记事应用，主打「暖色系 UI + 轻量本地存储」。项目内置富文本编辑、表情选择、图片/视频附件、回收站与数据统计等能力，支持 H5 与微信小程序等多端运行，无后端依赖，开箱即用。

- 仓库位置：`front/uni-preset-vue-vite/`
- 运行平台：H5、微信小程序（mp-weixin）等
- 数据存储：浏览器/小程序本地存储（无服务端）

## 技术栈

- 框架：Vue 3 + Uniapp
- 构建：Vite 5 + `@dcloudio/vite-plugin-uni`
- 语言：JavaScript、CSS
- 依赖核心：`@dcloudio/uni-app` 全家桶、`vue-i18n`（预留）

## 快速开始

- 安装依赖（在 `front/uni-preset-vue-vite/` 下）

```bash
npm install
```

- H5 开发预览

```bash
npm run dev:h5
```

- 微信小程序开发

```bash
npm run dev:mp-weixin
```

- H5 生产构建

```bash
npm run build:h5
```

- 微信小程序构建

```bash
npm run build:mp-weixin
```

提示：小程序开发构建产物位于 `dist/dev/mp-weixin`，可用微信开发者工具导入预览。

## 目录结构（关键）

```
src/
  pages/
    index/                # 首页：分类概览 + 全局统计
    category/             # 分类详情页：该分类下的日记列表
    category-manage/      # 分类管理页：增删改分类
    detail/               # 日记详情页
    edit/                 # 日记编辑页（富文本、附件）
    trash/                # 回收站页
  utils/
    storage.js            # 本地存储与业务数据接口
  App.vue                 # 全局样式与应用生命周期
  main.js                 # 入口（SSR 适配）
  pages.json              # 路由与页面样式配置
  manifest.json           # 应用与各端能力配置
```

## 页面与路由

- `/pages/index/index`：
  - 展示全局统计（总数、连续天数）与分类列表
  - 入口导航：进入分类、回收站、分类管理
- `/pages/category/category?id=...`：
  - 展示某分类下的日记卡片列表、附件缩略图、编辑/删除
- `/pages/detail/detail?id=...`：
  - 展示日记标题、内容（优先 `contentHtml`，否则 `content`）、附件轮播
- `/pages/edit/edit[?id=...&categoryId=...]`：
  - 新建/编辑日记；支持富文本格式、表情、图片/视频附件
- `/pages/trash/trash`：
  - 展示已删除日记，支持恢复/永久删除，且超过 30 天自动清理
- `/pages/category-manage/category-manage`：
  - 分类增删改、图标/颜色选择，默认分类不可删除

页面外观与导航栏样式在 `src/pages.json` 中统一配置为暖色系主题。

## 数据模型

- Diary（日记）
  - `id: string`（时间戳）
  - `title: string`
  - `content: string`（纯文本）
  - `contentHtml: string`（富文本 HTML）
  - `attachments: { type: 'image' | 'video', url: string }[]`
  - `categoryId: string`（默认 `default`）
  - `createTime: string`、`updateTime: string`（ISO）

- Trash Item（回收站）
  - 继承 Diary 字段 + `deletedTime: string`

- Category（分类）
  - `id: string`、`name: string`、`color: string`、`icon: string`、`createTime: string`
  - 预置默认分类：`{ id: 'default', name: '默认分类' }`

## 核心数据接口（`utils/storage.js`）

- 日记
  - `GetDiaryList()` / `GetDiaryById(id)`
  - `AddDiary(diary)` / `UpdateDiary(id, diary)`
  - `DeleteDiary(id)`（移动到回收站）
- 回收站
  - `GetTrashList()`（自动清理超 30 天）
  - `AddToTrash(diary)` / `RestoreFromTrash(id)`
  - `PermanentDeleteDiary(id)` / `ClearTrash()`
- 分类
  - `GetCategoryList()` / `GetCategoryById(id)` / `GetDiaryListByCategory(categoryId)`
  - `AddCategory(category)` / `UpdateCategory(id, category)` / `DeleteCategory(id)`
  - 统计：`GetCategoryStats(categoryId)` / 全局：`GetGlobalStats()`（总数、连续天数）

实现基于 `uni.getStorageSync / setStorageSync`，对异常进行了兜底处理。

## 关键交互说明（编辑页）

- 富文本工具栏：粗体/斜体/下划线/删除线，支持「全局状态」与「选区格式化」两种策略。
- 表情面板：内置 160+ 常用 emoji，点击即插入。
- 附件管理：图片/视频添加、预览、删除；编辑与详情页均做了图片预览体验优化。
- 回填逻辑：
  - 编辑已有日记时，优先回填 `contentHtml`，否则将 `content` 转换为 `<p>…<br/></p>` 的基础 HTML 再设置到 editor。
  - 考虑小程序端 `editor` 的 ready/上下文获取时序，增加了多次重试与状态标记（如 `didInitialFill`）。

## 配置要点

- `manifest.json`：应用信息、多端能力（如 mp-weixin 权限提示）、统计开关等。
- `pages.json`：页面路径、导航栏主题色、背景色等统一样式配置。
- `vite.config.js`：启用 `@dcloudio/vite-plugin-uni` 插件。

## 发布与调试

- H5：`npm run build:h5` 输出至 `dist/build/h5`（由 Uni 构建目录规则决定）。
- 微信小程序：`npm run dev:mp-weixin` 后，用微信开发者工具打开 `dist/dev/mp-weixin` 目录进行预览与真机调试。

如需更详细的小程序发布步骤，可参考仓库内《微信小程序发布指南.md》。

## 注意事项与限制

- 无后端依赖，清空浏览器数据或卸载小程序可能导致数据丢失；重要内容请及时备份。
- 富文本显示：详情页优先使用 `contentHtml` 渲染；仅 `content` 时按纯文本展示。
- 默认分类不可删除，删除其他分类会将其日记迁移到默认分类。
- 回收站自动清理超过 30 天的日记。

## 后续演进（建议）

- 富文本样式完整回显与所见即所得优化
- 附件拖拽排序与批量操作
- 搜索、标签/多级分类、Markdown 支持
- 云端同步与导入/导出、主题/深色模式

## 许可

MIT License

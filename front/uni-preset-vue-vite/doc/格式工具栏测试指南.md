# 工具栏实时格式状态测试指南

## 修改内容

### 1. 优化格式状态更新逻辑 (`useEditorFormat.js`)

**修改要点**：
- 使用 `!!` 确保格式状态为布尔值
- 简化 `toggleFormat` 方法，直接使用编辑器原生 `format()` 方法
- 删除复杂的选中文本格式处理，让编辑器自己处理
- 优化 `syncGlobalFormatsWithCursor` 方法，避免过度干预

### 2. 改进选择变化事件处理 (`useEditorContent.js`)

**修改要点**：
- 更准确地检测选中文本
- 改进格式状态获取逻辑
- 添加错误处理和降级方案
- 增强调试日志

### 3. 添加调试信息 (`EditorToolbar.vue`)

**修改要点**：
- 添加 `watch` 监控格式状态变化
- 增加按钮点击调试日志

## 预期效果

### 1. 光标移动时
- **期望**：工具栏按钮状态应该反映当前光标位置的格式
- **测试方法**：
  1. 在编辑器中输入一些普通文本和一些格式化文本（粗体、斜体等）
  2. 使用鼠标点击不同位置，观察工具栏按钮变化
  3. 控制台应该显示格式状态更新日志

### 2. 文本选择时
- **期望**：工具栏按钮状态应该反映选中文本的格式
- **测试方法**：
  1. 选中纯文本区域 → 所有格式按钮应该不高亮
  2. 选中粗体文本 → 粗体按钮应该高亮
  3. 选中包含多种格式的文本 → 对应的格式按钮都应该高亮
  4. 选中混合格式文本（部分粗体部分普通）→ 只要有任何粗体，粗体按钮就应该高亮

### 3. 格式切换时
- **期望**：按钮状态立即更新，格式正确应用
- **测试方法**：
  1. **有选中文本时**：
     - 选中文本点击格式按钮 → 只影响选中内容
     - 工具栏状态临时改变反映选中内容的新格式
     - 取消选中后，工具栏恢复到光标位置的实际格式
  2. **无选中文本时**：
     - 点击格式按钮 → 切换全局格式状态
     - 后续输入的文本应该应用该格式

### 4. 输入文本时
- **期望**：新输入的文本应用当前的全局格式状态
- **测试方法**：
  1. 激活粗体格式（按钮高亮）
  2. 在空白位置输入文本 → 文本应该是粗体
  3. 移动到其他位置再回来 → 格式状态应该保持

## 调试指南

### 控制台日志关键词
- `onEditorSelectionChange` - 选择变化事件
- `UpdateToolbarFromSelection` - 工具栏状态更新
- `SyncGlobalFormatsWithCursor` - 全局格式同步
- `ToggleFormat` - 格式切换
- `EditorToolbar - 格式状态变化` - 工具栏状态监控

### 常见问题排查

#### 1. 工具栏按钮不更新
**检查项**：
- 控制台是否有 `onEditorSelectionChange` 日志
- 是否有 `UpdateToolbarFromSelection` 日志
- 格式状态值是否正确传递

#### 2. 格式应用不生效
**检查项**：
- 编辑器上下文是否正确获取
- `toggleFormat` 方法是否被调用
- 编辑器 `format()` 方法是否执行成功

#### 3. 全局格式状态混乱
**检查项**：
- `globalFormatStates` 与 `formatStates` 的同步
- `syncGlobalFormatsWithCursor` 是否过度干预
- 选中文本与无选中文本的处理逻辑

## 代码架构

### Hook 职责
- **`useEditorFormat`**：格式状态管理 + 格式应用
- **`useEditorContent`**：编辑器事件处理 + 内容管理

### 状态管理
- **`formatStates`**：工具栏UI显示状态（响应式）
- **`globalFormatStates`**：全局格式状态（影响新输入）

### 事件流程
1. 用户操作（点击、选择、输入）
2. 编辑器触发事件（selectionchange、input）
3. Hook 处理事件并更新状态
4. 工具栏组件响应状态变化
5. UI 更新显示

## 下一步优化

如果当前版本还有问题，可以考虑：

1. **简化状态管理**：只使用一套格式状态
2. **优化事件处理**：减少事件处理的复杂性
3. **添加防抖**：避免快速操作导致的状态混乱
4. **使用编辑器原生API**：更多依赖编辑器自身的格式管理

---

**测试时间**：请在修改后立即测试
**关键验证**：光标移动 + 文本选择 + 格式切换 + 文本输入四个场景
# 云日记数据库表设计文档

> 本文档基于前端已实现功能设计数据库表结构，采用 MySQL 8.0+，字符集 utf8mb4。

---

## 📋 表设计概览

本系统共设计 **3 张核心表**：
1. **categories** - 分类表
2. **diaries** - 日记表
3. **trash** - 回收站表（通过 diaries 表的软删除实现）

---

## 1. 分类表 (categories)

### 表结构

| 字段名 | 类型 | 长度 | 允许空 | 默认值 | 说明 |
|--------|------|------|--------|--------|------|
| id | BIGINT | - | NOT NULL | AUTO_INCREMENT | 主键ID |
| name | VARCHAR | 50 | NOT NULL | - | 分类名称 |
| icon | VARCHAR | 50 | NULL | NULL | 图标（emoji 或图标名称） |
| color | VARCHAR | 20 | NULL | '#FF9A76' | 颜色值（十六进制） |
| is_default | TINYINT(1) | - | NOT NULL | 0 | 是否默认分类（1=是，0=否） |
| create_time | DATETIME | - | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| update_time | DATETIME | - | NULL | NULL ON UPDATE CURRENT_TIMESTAMP | 更新时间 |


### 建表语句

```sql
CREATE TABLE `categories` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `name` VARCHAR(50) NOT NULL COMMENT '分类名称',
  `icon` VARCHAR(50) DEFAULT NULL COMMENT '图标',
  `color` VARCHAR(20) DEFAULT '#FF9A76' COMMENT '颜色值',
  `is_default` TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否默认分类',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='分类表';
```

### 功能说明

1. **分类管理**：支持创建、编辑、删除分类
2. **默认分类**：系统必须有一个默认分类，删除其他分类时日记会移至默认分类
3. **颜色主题**：每个分类可设置独立的颜色主题
4. **图标支持**：支持 emoji 或自定义图标

### 初始数据

```sql
INSERT INTO `categories` (`name`, `icon`, `color`, `is_default`) VALUES
('默认分类', '📝', '#FF9A76', 1),
('工作', '💼', '#4CAF50', 0),
('生活', '🏠', '#2196F3', 0),
('旅行', '✈️', '#FF5722', 0);
```

---

## 2. 日记表 (diaries)

### 表结构

| 字段名 | 类型 | 长度 | 允许空 | 默认值 | 说明 |
|--------|------|------|--------|--------|------|
| id | BIGINT | - | NOT NULL | AUTO_INCREMENT | 主键ID |
| title | VARCHAR | 200 | NOT NULL | '无标题' | 日记标题 |
| content | TEXT | - | NOT NULL | - | 纯文本内容 |
| content_html | TEXT | - | NULL | NULL | HTML格式内容（富文本） |
| category_id | BIGINT | - | NOT NULL | - | 分类ID（外键） |
| is_deleted | TINYINT(1) | - | NOT NULL | 0 | 是否删除（软删除标记） |
| deleted_time | DATETIME | - | NULL | NULL | 删除时间 |
| create_time | DATETIME | - | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| update_time | DATETIME | - | NULL | NULL ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

### 索引设计

```sql
PRIMARY KEY (id)
INDEX idx_category_id (category_id)              -- 按分类查询
INDEX idx_is_deleted (is_deleted)                -- 区分正常/回收站
INDEX idx_create_time (create_time DESC)         -- 按创建时间降序排序
INDEX idx_update_time (update_time DESC)         -- 按更新时间排序
INDEX idx_deleted_time (deleted_time)            -- 回收站按删除时间排序
INDEX idx_category_deleted (category_id, is_deleted, create_time DESC)  -- 复合索引优化查询
FULLTEXT INDEX ft_content (title, content)       -- 全文搜索索引
```

### 建表语句

```sql
CREATE TABLE `diaries` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `title` VARCHAR(200) NOT NULL DEFAULT '无标题' COMMENT '日记标题',
  `content` TEXT NOT NULL COMMENT '纯文本内容',
  `content_html` TEXT DEFAULT NULL COMMENT 'HTML格式内容',
  `category_id` BIGINT NOT NULL COMMENT '分类ID',
  `is_deleted` TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否删除（0=否，1=是）',
  `deleted_time` DATETIME DEFAULT NULL COMMENT '删除时间',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_category_id` (`category_id`),
  KEY `idx_is_deleted` (`is_deleted`),
  KEY `idx_create_time` (`create_time` DESC),
  KEY `idx_update_time` (`update_time` DESC),
  KEY `idx_deleted_time` (`deleted_time`),
  KEY `idx_category_deleted` (`category_id`, `is_deleted`, `create_time` DESC),
  FULLTEXT KEY `ft_content` (`title`, `content`),
  CONSTRAINT `fk_diary_category` FOREIGN KEY (`category_id`) REFERENCES `categories` (`id`) ON DELETE RESTRICT ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='日记表';
```

### 功能说明

1. **日记CRUD**：创建、查看、编辑、删除日记
2. **软删除**：删除日记时不真正删除，而是标记 is_deleted=1，移入回收站
3. **分类关联**：每篇日记必须关联一个分类
4. **富文本支持**：content_html 字段存储富文本格式（加粗、斜体、列表等）
5. **全文搜索**：支持按标题和内容进行模糊搜索
6. **时间排序**：支持按创建时间或更新时间排序

### 软删除机制

```sql
-- 删除日记（移至回收站）
UPDATE diaries 
SET is_deleted = 1, deleted_time = NOW() 
WHERE id = ? AND is_deleted = 0;

-- 从回收站恢复
UPDATE diaries 
SET is_deleted = 0, deleted_time = NULL 
WHERE id = ? AND is_deleted = 1;

-- 永久删除
DELETE FROM diaries 
WHERE id = ? AND is_deleted = 1;
```

---

## 3. 回收站 (trash)

### 说明

回收站不是独立的表，而是通过 `diaries` 表的软删除机制实现：
- **is_deleted = 1** 的记录视为在回收站中
- **deleted_time** 记录删除时间，用于计算过期时间

### 查询语句

```sql
-- 获取回收站列表
SELECT 
  d.id,
  d.title,
  d.content,
  c.name AS category_name,
  d.deleted_time,
  DATE_ADD(d.deleted_time, INTERVAL 30 DAY) AS expire_time
FROM diaries d
LEFT JOIN categories c ON d.category_id = c.id
WHERE d.is_deleted = 1
ORDER BY d.deleted_time DESC;

-- 自动清理30天前的回收站记录
DELETE FROM diaries 
WHERE is_deleted = 1 
AND deleted_time < DATE_SUB(NOW(), INTERVAL 30 DAY);
```

### 功能说明

1. **30天自动清理**：删除后30天自动永久删除
2. **批量操作**：支持批量恢复和永久删除
3. **清空回收站**：一键清空所有回收站记录

---

## 4. 表关系图

```
┌─────────────────┐
│   categories    │
│─────────────────│
│ * id            │◄────────────┐
│   name          │             │
│   icon          │             │ FK
│   color         │             │
│   is_default    │             │
│   create_time   │             │
│   update_time   │             │
└─────────────────┘             │
                                │
                                │
┌─────────────────┐             │
│    diaries      │             │
│─────────────────│             │
│ * id            │             │
│   title         │             │
│   content       │             │
│   content_html  │             │
│   category_id   │─────────────┘
│   is_deleted    │
│   deleted_time  │
│   create_time   │
│   update_time   │
└─────────────────┘
```

---

## 5. 常用查询示例

### 5.1 获取分类及日记数量

```sql
SELECT 
  c.id,
  c.name,
  c.icon,
  c.color,
  COUNT(d.id) AS diary_count
FROM categories c
LEFT JOIN diaries d ON c.id = d.category_id AND d.is_deleted = 0
GROUP BY c.id
ORDER BY c.create_time ASC;
```

### 5.2 获取日记列表（分页）

```sql
SELECT 
  d.id,
  d.title,
  d.content,
  d.create_time,
  d.update_time,
  c.name AS category_name,
  c.icon AS category_icon,
  c.color AS category_color
FROM diaries d
INNER JOIN categories c ON d.category_id = c.id
WHERE d.is_deleted = 0
ORDER BY d.create_time DESC
LIMIT 20 OFFSET 0;
```

### 5.3 按分类筛选日记

```sql
SELECT * 
FROM diaries 
WHERE category_id = ? AND is_deleted = 0 
ORDER BY create_time DESC;
```

### 5.4 搜索日记（全文搜索）

```sql
SELECT * 
FROM diaries 
WHERE is_deleted = 0 
AND (title LIKE '%关键词%' OR content LIKE '%关键词%')
ORDER BY create_time DESC;
```

### 5.5 获取分类统计信息

```sql
SELECT 
  COUNT(*) AS total_count,
  COUNT(CASE WHEN YEAR(create_time) = YEAR(NOW()) AND MONTH(create_time) = MONTH(NOW()) THEN 1 END) AS this_month,
  COUNT(CASE WHEN YEARWEEK(create_time) = YEARWEEK(NOW()) THEN 1 END) AS this_week
FROM diaries
WHERE category_id = ? AND is_deleted = 0;
```

---

## 6. 性能优化建议

### 6.1 索引优化
- ✅ 已为高频查询字段添加索引
- ✅ 复合索引优化分类+删除状态查询
- ✅ 全文索引支持内容搜索

### 6.2 分页查询优化

```sql
-- 使用 LIMIT OFFSET 分页
SELECT * FROM diaries 
WHERE is_deleted = 0 
ORDER BY create_time DESC 
LIMIT 20 OFFSET 100;

-- 大数据量时使用游标分页（更高效）
SELECT * FROM diaries 
WHERE is_deleted = 0 AND id < ?
ORDER BY id DESC 
LIMIT 20;
```

### 6.3 定期维护
```sql
-- 定时任务：每天凌晨清理30天前的回收站记录
DELETE FROM diaries 
WHERE is_deleted = 1 
AND deleted_time < DATE_SUB(NOW(), INTERVAL 30 DAY);

-- 优化表
OPTIMIZE TABLE diaries;
```

---

## 7. 数据字典

### 7.1 is_deleted 字段说明
| 值 | 说明 |
|----|------|
| 0  | 正常状态 |
| 1  | 已删除（回收站） |

### 7.2 is_default 字段说明
| 值 | 说明 |
|----|------|
| 0  | 普通分类 |
| 1  | 默认分类（不可删除） |

---

## 8. 注意事项

### 8.1 数据完整性
- ⚠️ 删除分类时需检查该分类下是否有日记
- ⚠️ 必须保留至少一个默认分类
- ⚠️ 外键约束防止误删分类

### 8.2 字符集
- ✅ 使用 utf8mb4 支持 emoji 和特殊字符
- ✅ 排序规则 utf8mb4_unicode_ci

### 8.3 时区
- ✅ 数据库配置使用 Asia/Shanghai 时区
- ✅ 应用层统一处理时区转换

---

**文档版本**: v1.0  
**创建日期**: 2025-10-14  
**作者**: System  
**说明**: 本设计基于前端已实现的功能进行设计，未包含未来规划功能。

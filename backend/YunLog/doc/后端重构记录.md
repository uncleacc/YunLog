# åç«¯é‡æ„è®°å½•

## é‡æ„ç›®æ ‡

æ ¹æ®ç®€åŒ–çš„æ•°æ®åº“è¡¨è®¾è®¡,é‡æ„åç«¯å·¥ç¨‹ä»¥åŒ¹é…æ–°çš„æ•°æ®ç»“æ„ã€‚

## æ•°æ®åº“è®¾è®¡

åŸºäº `doc/æ•°æ®åº“è¡¨è®¾è®¡.md` çš„ç®€åŒ–è®¾è®¡:

### 1. åˆ†ç±»è¡¨ (categories)
- id, name, icon, color, is_default, create_time, update_time

### 2. æ—¥è®°è¡¨ (diaries)
- id, title, content, content_html, category_id, is_deleted, deleted_time, create_time, update_time

### 3. é™„ä»¶è¡¨ (attachments)
- id, diary_id, url, create_time
- **è¯´æ˜**: ä»…å­˜å‚¨å›¾ç‰‡URL,ä¸æ¶‰åŠæ–‡ä»¶ä¸Šä¼ åˆ°æœåŠ¡å™¨

### 4. å›æ”¶ç«™
- é€šè¿‡ diaries è¡¨çš„ is_deleted å­—æ®µå®ç°è½¯åˆ é™¤

## é‡æ„å†…å®¹

### âœ… å·²å®Œæˆçš„ä¿®æ”¹

#### 1. å®ä½“ç±» (Entity)

##### 1.1 Attachment.java - **å·²ä¿®æ”¹**
**ä½ç½®**: `src/main/java/io/github/uncleacc/yunlog/entity/Attachment.java`

**ä¿®æ”¹å†…å®¹**:
- âŒ åˆ é™¤å­—æ®µ: `filename`, `originalName`, `size`, `type`
- âœ… ä¿ç•™å­—æ®µ: `id`, `diaryId`, `url`
- ğŸ”„ é‡å‘½åå­—æ®µ: `uploadTime` â†’ `createTime`

**æœ€ç»ˆå­—æ®µ**:
```java
- Long id
- Long diaryId
- String url
- LocalDateTime createTime
```

##### 1.2 Category.java - **æ— éœ€ä¿®æ”¹**
**ä½ç½®**: `src/main/java/io/github/uncleacc/yunlog/entity/Category.java`

**å­—æ®µ**: id, name, icon, color, isDefault, createTime, updateTime
- âœ… å®Œå…¨ç¬¦åˆæ•°æ®åº“è®¾è®¡

##### 1.3 Diary.java - **æ— éœ€ä¿®æ”¹**
**ä½ç½®**: `src/main/java/io/github/uncleacc/yunlog/entity/Diary.java`

**å­—æ®µ**: id, title, content, contentHtml, categoryId, isDeleted, deletedTime, createTime, updateTime
- âœ… å®Œå…¨ç¬¦åˆæ•°æ®åº“è®¾è®¡

#### 2. æ•°æ®è®¿é—®å±‚ (Repository) - **æ–°å¢**

##### 2.1 AttachmentRepository.java - **æ–°å»º**
**ä½ç½®**: `src/main/java/io/github/uncleacc/yunlog/repository/AttachmentRepository.java`

**åŠŸèƒ½**:
- æ ¹æ®æ—¥è®°IDæŸ¥è¯¢é™„ä»¶åˆ—è¡¨
- æ ¹æ®æ—¥è®°IDåˆ é™¤æ‰€æœ‰é™„ä»¶
- ç»Ÿè®¡æŒ‡å®šæ—¥è®°çš„é™„ä»¶æ•°é‡

#### 3. æ•°æ®ä¼ è¾“å¯¹è±¡ (DTO) - **æ–°å¢**

##### 3.1 CreateAttachmentRequest.java - **æ–°å»º**
**ä½ç½®**: `src/main/java/io/github/uncleacc/yunlog/dto/request/CreateAttachmentRequest.java`

**å­—æ®µ**:
```java
- Long diaryId (å¿…å¡«)
- String url (å¿…å¡«, æœ€å¤§500å­—ç¬¦)
```

#### 4. ä¸šåŠ¡é€»è¾‘å±‚ (Service)

##### 4.1 AttachmentService.java - **æ–°å»º**
**ä½ç½®**: `src/main/java/io/github/uncleacc/yunlog/service/AttachmentService.java`

**åŠŸèƒ½**:
- æ ¹æ®æ—¥è®°IDè·å–é™„ä»¶åˆ—è¡¨
- æ ¹æ®IDè·å–é™„ä»¶è¯¦æƒ…
- åˆ›å»ºå•ä¸ªé™„ä»¶
- æ‰¹é‡åˆ›å»ºé™„ä»¶
- åˆ é™¤å•ä¸ªé™„ä»¶
- æ ¹æ®æ—¥è®°IDåˆ é™¤æ‰€æœ‰é™„ä»¶
- æ‰¹é‡åˆ é™¤é™„ä»¶

##### 4.2 DiaryService.java - **å·²ä¿®æ”¹**
**ä½ç½®**: `src/main/java/io/github/uncleacc/yunlog/service/DiaryService.java`

**ä¿®æ”¹å†…å®¹**:
- â• æ–°å¢ä¾èµ–: `AttachmentRepository`
- ğŸ”„ ä¿®æ”¹æ–¹æ³• `permanentDeleteDiary()`: æ°¸ä¹…åˆ é™¤æ—¥è®°å‰å…ˆåˆ é™¤å…¶æ‰€æœ‰é™„ä»¶
- ğŸ”„ ä¿®æ”¹æ–¹æ³• `clearTrash()`: æ¸…ç©ºåƒåœ¾æ¡¶æ—¶æ‰¹é‡åˆ é™¤æ‰€æœ‰æ—¥è®°çš„é™„ä»¶

**ä¿®æ”¹å‰**:
```java
public void permanentDeleteDiary(Long id) {
    Diary diary = ...;
    diaryRepository.delete(diary);
}
```

**ä¿®æ”¹å**:
```java
public void permanentDeleteDiary(Long id) {
    Diary diary = ...;
    // å…ˆåˆ é™¤é™„ä»¶
    attachmentRepository.deleteByDiaryId(id);
    // å†åˆ é™¤æ—¥è®°
    diaryRepository.delete(diary);
}
```

#### 5. æ§åˆ¶å™¨å±‚ (Controller) - **æ–°å¢**

##### 5.1 AttachmentController.java - **æ–°å»º**
**ä½ç½®**: `src/main/java/io/github/uncleacc/yunlog/controller/AttachmentController.java`

**API ç«¯ç‚¹**:

| æ–¹æ³• | è·¯å¾„ | åŠŸèƒ½ | è¯´æ˜ |
|------|------|------|------|
| GET | `/attachments/diary/{diaryId}` | è·å–æ—¥è®°çš„é™„ä»¶åˆ—è¡¨ | è¿”å›æŒ‡å®šæ—¥è®°çš„æ‰€æœ‰é™„ä»¶ |
| GET | `/attachments/{id}` | è·å–é™„ä»¶è¯¦æƒ… | æ ¹æ®IDè·å–å•ä¸ªé™„ä»¶ |
| POST | `/attachments` | åˆ›å»ºé™„ä»¶ | æ·»åŠ å•ä¸ªé™„ä»¶ |
| POST | `/attachments/batch` | æ‰¹é‡åˆ›å»ºé™„ä»¶ | æ‰¹é‡æ·»åŠ å¤šä¸ªé™„ä»¶URL |
| DELETE | `/attachments/{id}` | åˆ é™¤é™„ä»¶ | åˆ é™¤å•ä¸ªé™„ä»¶ |
| DELETE | `/attachments/diary/{diaryId}` | åˆ é™¤æ—¥è®°çš„æ‰€æœ‰é™„ä»¶ | åˆ é™¤æŒ‡å®šæ—¥è®°çš„æ‰€æœ‰é™„ä»¶ |
| DELETE | `/attachments/batch` | æ‰¹é‡åˆ é™¤é™„ä»¶ | æ‰¹é‡åˆ é™¤å¤šä¸ªé™„ä»¶ |

### ğŸ“‹ ä»£ç ç»Ÿè®¡

#### æ–°å¢æ–‡ä»¶ (4ä¸ª)
1. `AttachmentRepository.java` - æ¥å£ (Repository)
2. `CreateAttachmentRequest.java` - DTO
3. `AttachmentService.java` - ä¸šåŠ¡é€»è¾‘ (~110è¡Œ)
4. `AttachmentController.java` - æ§åˆ¶å™¨ (~120è¡Œ)

#### ä¿®æ”¹æ–‡ä»¶ (2ä¸ª)
1. `Attachment.java` - å®ä½“ç±» (åˆ é™¤4ä¸ªå­—æ®µ,é‡å‘½å1ä¸ªå­—æ®µ)
2. `DiaryService.java` - ä¸šåŠ¡é€»è¾‘ (æ–°å¢ä¾èµ–,ä¿®æ”¹2ä¸ªæ–¹æ³•)

#### æ— éœ€ä¿®æ”¹ (2ä¸ª)
1. `Category.java` - å®ä½“ç±»
2. `Diary.java` - å®ä½“ç±»

### âš™ï¸ æŠ€æœ¯è¦ç‚¹

#### 1. æ•°æ®çº§è”åˆ é™¤
- æ°¸ä¹…åˆ é™¤æ—¥è®°æ—¶,è‡ªåŠ¨åˆ é™¤å…¶æ‰€æœ‰é™„ä»¶
- æ¸…ç©ºåƒåœ¾æ¡¶æ—¶,æ‰¹é‡åˆ é™¤æ‰€æœ‰æ—¥è®°çš„é™„ä»¶
- ä½¿ç”¨ `@Transactional` ä¿è¯æ•°æ®ä¸€è‡´æ€§

#### 2. Java 8 å…¼å®¹æ€§
- é¡¹ç›®ä½¿ç”¨ Java 8
- é¿å…ä½¿ç”¨ `Stream.toList()` (Java 16+)
- ä½¿ç”¨ä¼ ç»Ÿ for å¾ªç¯æˆ– `Collectors.toList()`

#### 3. é™„ä»¶ç®¡ç†è®¾è®¡
- é™„ä»¶è¡¨åªå­˜å‚¨å›¾ç‰‡URL,ä¸æ¶‰åŠæ–‡ä»¶ä¸Šä¼ 
- å‰ç«¯å¯ä»¥é€šè¿‡äº‘å­˜å‚¨æœåŠ¡(å¦‚OSS)ä¸Šä¼ å›¾ç‰‡å,å°†URLä¿å­˜åˆ°æ•°æ®åº“
- æ”¯æŒæ‰¹é‡åˆ›å»ºå’Œåˆ é™¤æ“ä½œ

### ğŸ” éªŒè¯æ¸…å•

- [x] æ‰€æœ‰å®ä½“ç±»å­—æ®µä¸æ•°æ®åº“è®¾è®¡ä¸€è‡´
- [x] AttachmentRepository æ¥å£å®šä¹‰æ­£ç¡®
- [x] AttachmentService ä¸šåŠ¡é€»è¾‘å®Œæ•´
- [x] AttachmentController APIç«¯ç‚¹é½å…¨
- [x] DiaryService çº§è”åˆ é™¤é€»è¾‘å·²æ·»åŠ 
- [x] æ‰€æœ‰æ–‡ä»¶æ— ç¼–è¯‘é”™è¯¯
- [x] Java 8 å…¼å®¹æ€§æ£€æŸ¥é€šè¿‡

### ğŸ“ åç»­å·¥ä½œå»ºè®®

#### 1. API æµ‹è¯•
- æµ‹è¯•æ‰€æœ‰é™„ä»¶ç›¸å…³çš„APIç«¯ç‚¹
- æµ‹è¯•æ°¸ä¹…åˆ é™¤æ—¥è®°æ—¶çš„çº§è”åˆ é™¤
- æµ‹è¯•æ¸…ç©ºåƒåœ¾æ¡¶æ—¶çš„æ‰¹é‡åˆ é™¤

#### 2. å‰ç«¯é›†æˆ
- å‰ç«¯åœ¨ç¼–è¾‘æ—¥è®°æ—¶æ”¯æŒæ·»åŠ å›¾ç‰‡URL
- å‰ç«¯æ˜¾ç¤ºæ—¥è®°æ—¶åŠ è½½å¹¶å±•ç¤ºé™„ä»¶å›¾ç‰‡
- å‰ç«¯åˆ é™¤æ—¥è®°æ—¶æç¤ºé™„ä»¶ä¹Ÿä¼šè¢«åˆ é™¤

#### 3. æ•°æ®åº“è„šæœ¬
- åˆ›å»º attachments è¡¨çš„å»ºè¡¨SQL
- å¦‚æœ‰æ—§æ•°æ®,ç¼–å†™æ•°æ®è¿ç§»è„šæœ¬

#### 4. æ–‡æ¡£æ›´æ–°
- æ›´æ–° API æ–‡æ¡£,æ·»åŠ é™„ä»¶ç®¡ç†ç›¸å…³æ¥å£
- æ›´æ–°éƒ¨ç½²æ–‡æ¡£,è¯´æ˜æ–°å¢çš„é™„ä»¶è¡¨

### ğŸ“š ç›¸å…³æ–‡æ¡£

- `doc/æ•°æ®åº“è¡¨è®¾è®¡.md` - æ•°æ®åº“è®¾è®¡æ–‡æ¡£
- `doc/æ— ç”¨æˆ·è®¤è¯APIæ–‡æ¡£.md` - APIæ–‡æ¡£ (éœ€æ›´æ–°)
- `README.md` - é¡¹ç›®è¯´æ˜ (éœ€æ›´æ–°)

---

**é‡æ„å®Œæˆæ—¶é—´**: 2025-01-XX  
**é‡æ„åŸå› **: ç®€åŒ–æ•°æ®åº“è®¾è®¡,ç§»é™¤ä¸å¿…è¦çš„å­—æ®µå’Œç´¢å¼•  
**å½±å“èŒƒå›´**: Attachment å®ä½“åŠç›¸å…³é™„ä»¶ç®¡ç†åŠŸèƒ½  
**å‘åå…¼å®¹**: éœ€è¦æ•°æ®åº“è¿ç§»


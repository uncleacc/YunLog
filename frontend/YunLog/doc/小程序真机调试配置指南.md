# 小程序真机调试配置指南

## 📱 问题说明

小程序真机调试时，手机无法访问 `localhost`，因为：
- `localhost` 只能在本机访问
- 手机和电脑是不同的设备
- 需要使用局域网 IP 地址

## ✅ 解决方案

### 1️⃣ 自动配置（已完成）

代码已自动配置为：
- **H5 环境**：使用 `localhost:8080`（PC 浏览器访问）
- **小程序环境**：使用 `172.20.10.13:8080`（手机访问）

### 2️⃣ 确保手机和电脑在同一网络

**重要**：手机和电脑必须连接到同一个 WiFi 网络！

- ✅ 手机连接：你的 WiFi 名称
- ✅ 电脑连接：同一个 WiFi
- ❌ 不要使用：手机流量、不同的 WiFi

### 3️⃣ 微信开发者工具配置

#### 方法一：关闭域名校验（推荐开发阶段使用）

1. 打开微信开发者工具
2. 点击右上角「详情」
3. 找到「本地设置」
4. **勾选**「不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书」
5. 保存设置

#### 方法二：配置合法域名（用于正式发布）

如果你有正式域名和 HTTPS 证书：
1. 登录[微信公众平台](https://mp.weixin.qq.com/)
2. 进入「开发」->「开发管理」->「开发设置」
3. 在「服务器域名」中添加：
   - request合法域名：`https://你的域名.com`
   - uploadFile合法域名：`https://你的域名.com`

### 4️⃣ 真机预览步骤

1. **启动后端服务**
   ```bash
   cd backend/YunLog
   ./start.sh
   ```
   确保后端在 `8080` 端口运行

2. **编译小程序代码**
   ```bash
   cd frontend/YunLog
   npm run dev:mp-weixin
   ```

3. **微信开发者工具**
   - 导入项目（选择 `frontend/YunLog` 目录）
   - 点击「预览」按钮
   - 用手机微信扫描二维码

4. **手机测试**
   - 扫码后在手机上打开小程序
   - 确保手机和电脑在同一 WiFi
   - 开始测试功能

## 🔧 如果 IP 地址变化了

当电脑的局域网 IP 变化时（例如重启路由器、更换网络），需要更新配置：

### 查看当前 IP
```bash
# Mac/Linux
ifconfig | grep "inet "

# Windows
ipconfig
```

### 更新配置文件

修改 `src/utils/request.js` 中的 IP 地址：

```javascript
// #ifdef MP-WEIXIN || APP-PLUS
return 'http://你的新IP:8080/api/v1'  // 👈 修改这里
// #endif
```

## 🐛 常见问题

### Q1: 手机无法访问后端？

**检查清单**：
- [ ] 后端服务是否启动？访问 `http://localhost:8080/api/v1/health` 测试
- [ ] 手机和电脑是否在同一 WiFi？
- [ ] 防火墙是否阻止了 8080 端口？
- [ ] IP 地址是否正确？

**Mac 防火墙设置**：
1. 系统设置 -> 网络 -> 防火墙
2. 点击「防火墙选项」
3. 确保 Java 或你的应用允许传入连接

### Q2: 微信提示"不在以下 request 合法域名列表中"？

**解决方法**：
- 开发阶段：微信开发者工具中关闭「域名校验」
- 正式发布：配置 HTTPS 和合法域名

### Q3: 扫码后小程序打不开？

**检查**：
- 确认小程序 AppID 已配置
- 检查是否已添加为体验者
- 查看微信开发者工具的错误日志

### Q4: H5 能用，小程序不能用？

**原因**：编译结果不同
- H5 编译后使用 localhost
- 小程序编译后使用局域网 IP

**解决**：清理缓存重新编译
```bash
rm -rf unpackage/
npm run dev:mp-weixin
```

## 📊 测试验证

测试 API 是否可访问：

### 在电脑上测试
```bash
curl http://localhost:8080/api/v1/health
```

### 在手机浏览器测试
访问：`http://172.20.10.13:8080/api/v1/health`

如果能看到返回数据，说明配置成功！

## 🚀 生产环境部署

正式上线时需要：

1. **购买域名和 SSL 证书**
2. **部署到云服务器**
3. **配置 Nginx 反向代理**
4. **在微信公众平台配置合法域名**
5. **修改代码使用 HTTPS**

生产环境配置示例：
```javascript
const BASE_URL = 'https://api.yourdomain.com/api/v1'
```

## 📝 相关文档

- [微信小程序网络配置](https://developers.weixin.qq.com/miniprogram/dev/framework/ability/network.html)
- [uni-app 条件编译](https://uniapp.dcloud.net.cn/tutorial/platform.html)
- [Spring Boot CORS 配置](../../../backend/YunLog/README.md)

## 🔄 当前配置摘要

| 环境 | API 地址 | 说明 |
|-----|---------|------|
| H5 开发 | `http://localhost:8080/api/v1` | PC 浏览器访问 |
| 小程序开发 | `http://172.20.10.13:8080/api/v1` | 手机通过局域网访问 |
| 生产环境 | `https://your-domain.com/api/v1` | 需配置 HTTPS 和域名 |

---

**最后更新时间**：2025-10-25  
**当前电脑 IP**：172.20.10.13  
**后端端口**：8080

# 登录功能更新说明

## 更新日期
2025年11月21日

## 更新内容

### 1. 前端更新

#### 1.1 登录页面重构 (`login.vue`)
- ✅ **删除**：账号密码登录功能
- ✅ **新增**：手机验证码登录
  - 手机号输入（11位数字验证）
  - 验证码输入（6位数字）
  - 获取验证码按钮（60秒倒计时）
  - 自动注册功能（未注册手机号验证后自动创建账号）
- ✅ **保留**：微信一键登录
- ✅ **优化**：色系调整为暖色系（与主页一致）
  - 主色调：#FF9A76 → #FF7E5F 渐变
  - 背景色：FFF5F0（与主页一致）
  - 按钮样式统一

#### 1.2 API更新 (`api.js`)
- ✅ **删除**：`register()` - 注册接口
- ✅ **删除**：`login()` - 账号密码登录接口
- ✅ **新增**：`sendSmsCode(data)` - 发送短信验证码
- ✅ **新增**：`phoneLogin(data)` - 手机验证码登录
- ✅ **保留**：`wechatLogin(data)` - 微信登录
- ✅ **保留**：`logout()` - 登出

### 2. 后端更新

#### 2.1 短信服务架构
采用可扩展的接口设计，方便切换不同短信服务商

**接口定义** (`SmsService.java`)
```java
public interface SmsService {
    boolean sendVerifyCode(String phone, String code);
    boolean verifyCode(String phone, String code);
    String generateCode();
}
```

**阿里云实现** (`AliyunSmsServiceImpl.java`)
- ✅ 支持阿里云短信服务（需配置AccessKey）
- ✅ 开发模式：未启用时使用模拟发送（仅存储验证码到Redis）
- ✅ 验证码有效期：5分钟
- ✅ 验证码格式：6位数字
- ✅ Redis存储：验证成功后自动删除

#### 2.2 认证服务更新

**DTO类**
- ✅ `SendSmsRequest.java` - 发送验证码请求（手机号验证）
- ✅ `PhoneLoginRequest.java` - 手机登录请求（手机号+验证码验证）

**AuthService接口新增方法**
```java
AuthResponse phoneLogin(PhoneLoginRequest request);
```

**AuthServiceImpl实现**
- ✅ 验证码校验
- ✅ 自动注册新用户
- ✅ 自动生成用户名（user_手机号后4位）
- ✅ 自动创建默认分类
- ✅ 返回JWT token

**AuthController新增接口**
- ✅ `POST /api/v1/auth/sms/send` - 发送验证码
- ✅ `POST /api/v1/auth/phone/login` - 手机登录

#### 2.3 依赖更新 (`pom.xml`)
```xml
<!-- Spring Boot Redis 启动器 -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-redis</artifactId>
</dependency>

<!-- Lettuce 连接池 -->
<dependency>
    <groupId>org.apache.commons</groupId>
    <artifactId>commons-pool2</artifactId>
</dependency>
```

#### 2.4 配置更新 (`application.yml`)

**Redis配置**
```yaml
spring:
  redis:
    host: localhost
    port: 6379
    password: 
    database: 0
    timeout: 5000ms
```

**阿里云短信配置**
```yaml
aliyun:
  sms:
    enabled: false  # 开发环境使用模拟模式
    access-key-id: ${ALIYUN_SMS_ACCESS_KEY_ID:}
    access-key-secret: ${ALIYUN_SMS_ACCESS_KEY_SECRET:}
    sign-name: 云日记
    template-code: ${ALIYUN_SMS_TEMPLATE_CODE:}
```

### 3. 代码扩展性设计

#### 3.1 短信服务商切换
只需实现 `SmsService` 接口即可切换到其他短信服务商：

**示例：腾讯云短信服务**
```java
@Service
@Primary  // 设置为主要实现
public class TencentSmsServiceImpl implements SmsService {
    @Override
    public boolean sendVerifyCode(String phone, String code) {
        // 调用腾讯云SDK发送短信
    }
    
    @Override
    public boolean verifyCode(String phone, String code) {
        // 验证逻辑（与阿里云实现相同）
    }
    
    @Override
    public String generateCode() {
        // 生成验证码（与阿里云实现相同）
    }
}
```

#### 3.2 验证码存储方式切换
当前使用Redis存储，可通过修改 `AliyunSmsServiceImpl` 切换为：
- 数据库存储
- 缓存存储
- 其他NoSQL数据库

### 4. 部署说明

#### 4.1 开发环境
1. **安装Redis**
   ```bash
   # macOS
   brew install redis
   brew services start redis
   
   # Linux
   sudo apt-get install redis-server
   sudo systemctl start redis
   ```

2. **配置说明**
   - 开发环境：`aliyun.sms.enabled=false`（使用模拟模式）
   - 验证码会打印在后端日志中，方便测试

3. **测试流程**
   - 输入手机号点击"获取验证码"
   - 查看后端日志获取验证码
   - 输入验证码登录

#### 4.2 生产环境
1. **配置阿里云短信服务**
   ```yaml
   aliyun:
     sms:
       enabled: true
       access-key-id: <您的AccessKey ID>
       access-key-secret: <您的AccessKey Secret>
       sign-name: <您的短信签名>
       template-code: <您的模板代码>
   ```

2. **配置Redis**
   ```yaml
   spring:
     redis:
       host: <Redis服务器地址>
       port: 6379
       password: <Redis密码>
   ```

3. **环境变量方式**（推荐）
   ```bash
   export ALIYUN_SMS_ENABLED=true
   export ALIYUN_SMS_ACCESS_KEY_ID=xxx
   export ALIYUN_SMS_ACCESS_KEY_SECRET=xxx
   export REDIS_HOST=xxx
   export REDIS_PASSWORD=xxx
   ```

### 5. API文档

#### 5.1 发送短信验证码
```http
POST /api/v1/auth/sms/send
Content-Type: application/json

{
  "phone": "13800138000"
}
```

**响应**
```json
{
  "code": 200,
  "message": "验证码已发送",
  "data": null
}
```

#### 5.2 手机验证码登录
```http
POST /api/v1/auth/phone/login
Content-Type: application/json

{
  "phone": "13800138000",
  "code": "123456"
}
```

**响应**
```json
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiJ9...",
    "userInfo": {
      "id": 1,
      "username": "user_8000",
      "phone": "13800138000",
      "wechatOpenid": null
    }
  }
}
```

### 6. 注意事项

1. **Redis依赖**
   - 短信验证码功能依赖Redis
   - 确保Redis服务正常运行
   - 验证码有效期5分钟

2. **手机号验证**
   - 支持中国大陆手机号（1开头，11位数字）
   - 前端和后端都有验证

3. **验证码安全**
   - 验证码使用后自动删除
   - 过期时间5分钟
   - 建议增加发送频率限制（可使用Redis实现）

4. **阿里云短信**
   - 需要申请阿里云短信服务
   - 需要配置短信签名和模板
   - 开发环境可使用模拟模式

### 7. 后续优化建议

1. **发送频率限制**
   - 同一手机号60秒内只能发送一次
   - 同一IP每天限制发送次数

2. **图形验证码**
   - 发送短信前先验证图形验证码
   - 防止恶意刷短信

3. **多渠道登录绑定**
   - 允许同一账号绑定手机号和微信
   - 支持切换登录方式

4. **登录日志**
   - 记录登录时间、IP地址
   - 异常登录提醒

## 总结

本次更新完全移除了账号密码登录，改为更安全便捷的手机验证码登录和微信一键登录。代码架构考虑了扩展性，可以方便地切换短信服务商。前端界面也统一为暖色系，与应用主题保持一致。

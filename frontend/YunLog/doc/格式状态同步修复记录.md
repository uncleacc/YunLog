# 格式按钮状态同步修复记录

## 问题描述
工具栏格式按钮的高亮状态与编辑器的实际格式状态不一致，导致用户无法准确了解当前光标位置或选中文本的格式状态。

## 解决方案
参考 `editor.vue` 的实现，使用编辑器原生的 `statuschange` 事件来同步格式状态。

## 关键改进

### 1. 添加 statuschange 事件监听
**修改文件**: `src/pages/edit/components/EditorArea.vue`

- 添加 `@statuschange="onEditorStatusChange"` 事件监听
- 添加 `editor-status-change` 事件发射
- 新增 `onEditorStatusChange` 方法转发事件

### 2. 实现状态同步逻辑
**修改文件**: `src/pages/edit/edit.vue`

- 添加 `@editor-status-change="handleEditorStatusChange"` 事件监听
- 新增 `handleEditorStatusChange` 方法，直接从编辑器状态更新格式按钮状态
- 修改 `handleToggleFormat` 方法，使用编辑器原生 `format()` 方法

### 3. 核心实现逻辑

```javascript
// 处理编辑器状态变化
handleEditorStatusChange(e) {
  console.log('handleEditorStatusChange - 编辑器状态变化:', e.detail)
  const formats = e.detail
  
  if (formats) {
    this.formatStates.bold = !!formats.bold
    this.formatStates.italic = !!formats.italic
    this.formatStates.underline = !!formats.underline
    this.formatStates.strikethrough = !!(formats.strike || formats.strikeThrough)
  }
}

// 处理格式切换
handleToggleFormat(format) {
  if (!this.editorCtx) return
  
  const formatMap = {
    bold: 'bold',
    italic: 'italic',
    underline: 'underline',
    strikethrough: 'strike'  // 编辑器使用 'strike'
  }
  
  const editorFormatName = formatMap[format]
  if (editorFormatName) {
    this.editorCtx.format(editorFormatName)  // 触发 statuschange 事件
  }
}
```

## 工作原理

### 事件流程
1. **用户操作** → 点击格式按钮或移动光标
2. **编辑器响应** → 调用 `editorCtx.format()` 或光标位置改变
3. **状态变化** → 编辑器触发 `statuschange` 事件
4. **状态同步** → `handleEditorStatusChange` 更新 `formatStates`
5. **UI更新** → 工具栏按钮自动反映新状态

### 关键优势
- **实时同步**: 格式状态直接来自编辑器内核，确保准确性
- **自动更新**: 无需手动管理复杂的状态逻辑
- **兼容性好**: 使用编辑器原生API，稳定可靠

## 格式映射

| 工具栏格式名 | 编辑器格式名 | 说明 |
|------------|------------|------|
| bold | bold | 粗体 |
| italic | italic | 斜体 |
| underline | underline | 下划线 |
| strikethrough | strike | 删除线(注意名称差异) |

## 测试验证

### 测试场景
1. **光标移动测试**:
   - 在不同格式的文本中移动光标
   - 按钮状态应实时反映当前位置格式

2. **文本选择测试**:
   - 选中不同格式的文本
   - 按钮状态应反映选中内容的格式

3. **格式切换测试**:
   - 点击格式按钮
   - 按钮状态应立即更新并保持同步

### 预期结果
- ✅ 按钮高亮状态与编辑器实际格式完全一致
- ✅ 格式切换后状态立即正确更新
- ✅ 光标移动时状态实时跟随
- ✅ 选中文本时状态准确反映

## 调试信息

### 关键日志
- `handleEditorStatusChange - 编辑器状态变化:` - 状态变化事件
- `handleToggleFormat - 切换格式:` - 格式切换操作
- `EditorToolbar - 格式状态变化:` - 工具栏状态监控

### 状态验证
可以通过控制台查看：
1. `e.detail` 中的格式状态值
2. `this.formatStates` 的更新情况
3. 工具栏组件的 `watch` 触发情况

## 后续优化

如果还有问题，可以考虑：
1. **增加防抖**: 避免频繁的状态更新
2. **状态缓存**: 提高性能
3. **错误处理**: 增强健壮性
4. **更多格式**: 支持字体大小、颜色等

---

**修改时间**: 2025年10月13日
**修改目标**: 实现格式按钮状态与编辑器状态的完全同步
**核心方法**: 使用编辑器原生 `statuschange` 事件
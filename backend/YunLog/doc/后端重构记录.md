# 后端重构记录

## 重构目标

根据简化的数据库表设计,重构后端工程以匹配新的数据结构。

## 数据库设计

基于 `doc/数据库表设计.md` 的简化设计:

### 1. 分类表 (categories)
- id, name, icon, color, is_default, create_time, update_time

### 2. 日记表 (diaries)
- id, title, content, content_html, category_id, is_deleted, deleted_time, create_time, update_time

### 3. 附件表 (attachments)
- id, diary_id, url, create_time
- **说明**: 仅存储图片URL,不涉及文件上传到服务器

### 4. 回收站
- 通过 diaries 表的 is_deleted 字段实现软删除

## 重构内容

### ✅ 已完成的修改

#### 1. 实体类 (Entity)

##### 1.1 Attachment.java - **已修改**
**位置**: `src/main/java/io/github/uncleacc/yunlog/entity/Attachment.java`

**修改内容**:
- ❌ 删除字段: `filename`, `originalName`, `size`, `type`
- ✅ 保留字段: `id`, `diaryId`, `url`
- 🔄 重命名字段: `uploadTime` → `createTime`

**最终字段**:
```java
- Long id
- Long diaryId
- String url
- LocalDateTime createTime
```

##### 1.2 Category.java - **无需修改**
**位置**: `src/main/java/io/github/uncleacc/yunlog/entity/Category.java`

**字段**: id, name, icon, color, isDefault, createTime, updateTime
- ✅ 完全符合数据库设计

##### 1.3 Diary.java - **无需修改**
**位置**: `src/main/java/io/github/uncleacc/yunlog/entity/Diary.java`

**字段**: id, title, content, contentHtml, categoryId, isDeleted, deletedTime, createTime, updateTime
- ✅ 完全符合数据库设计

#### 2. 数据访问层 (Repository) - **新增**

##### 2.1 AttachmentRepository.java - **新建**
**位置**: `src/main/java/io/github/uncleacc/yunlog/repository/AttachmentRepository.java`

**功能**:
- 根据日记ID查询附件列表
- 根据日记ID删除所有附件
- 统计指定日记的附件数量

#### 3. 数据传输对象 (DTO) - **新增**

##### 3.1 CreateAttachmentRequest.java - **新建**
**位置**: `src/main/java/io/github/uncleacc/yunlog/dto/request/CreateAttachmentRequest.java`

**字段**:
```java
- Long diaryId (必填)
- String url (必填, 最大500字符)
```

#### 4. 业务逻辑层 (Service)

##### 4.1 AttachmentService.java - **新建**
**位置**: `src/main/java/io/github/uncleacc/yunlog/service/AttachmentService.java`

**功能**:
- 根据日记ID获取附件列表
- 根据ID获取附件详情
- 创建单个附件
- 批量创建附件
- 删除单个附件
- 根据日记ID删除所有附件
- 批量删除附件

##### 4.2 DiaryService.java - **已修改**
**位置**: `src/main/java/io/github/uncleacc/yunlog/service/DiaryService.java`

**修改内容**:
- ➕ 新增依赖: `AttachmentRepository`
- 🔄 修改方法 `permanentDeleteDiary()`: 永久删除日记前先删除其所有附件
- 🔄 修改方法 `clearTrash()`: 清空垃圾桶时批量删除所有日记的附件

**修改前**:
```java
public void permanentDeleteDiary(Long id) {
    Diary diary = ...;
    diaryRepository.delete(diary);
}
```

**修改后**:
```java
public void permanentDeleteDiary(Long id) {
    Diary diary = ...;
    // 先删除附件
    attachmentRepository.deleteByDiaryId(id);
    // 再删除日记
    diaryRepository.delete(diary);
}
```

#### 5. 控制器层 (Controller) - **新增**

##### 5.1 AttachmentController.java - **新建**
**位置**: `src/main/java/io/github/uncleacc/yunlog/controller/AttachmentController.java`

**API 端点**:

| 方法 | 路径 | 功能 | 说明 |
|------|------|------|------|
| GET | `/attachments/diary/{diaryId}` | 获取日记的附件列表 | 返回指定日记的所有附件 |
| GET | `/attachments/{id}` | 获取附件详情 | 根据ID获取单个附件 |
| POST | `/attachments` | 创建附件 | 添加单个附件 |
| POST | `/attachments/batch` | 批量创建附件 | 批量添加多个附件URL |
| DELETE | `/attachments/{id}` | 删除附件 | 删除单个附件 |
| DELETE | `/attachments/diary/{diaryId}` | 删除日记的所有附件 | 删除指定日记的所有附件 |
| DELETE | `/attachments/batch` | 批量删除附件 | 批量删除多个附件 |

### 📋 代码统计

#### 新增文件 (4个)
1. `AttachmentRepository.java` - 接口 (Repository)
2. `CreateAttachmentRequest.java` - DTO
3. `AttachmentService.java` - 业务逻辑 (~110行)
4. `AttachmentController.java` - 控制器 (~120行)

#### 修改文件 (2个)
1. `Attachment.java` - 实体类 (删除4个字段,重命名1个字段)
2. `DiaryService.java` - 业务逻辑 (新增依赖,修改2个方法)

#### 无需修改 (2个)
1. `Category.java` - 实体类
2. `Diary.java` - 实体类

### ⚙️ 技术要点

#### 1. 数据级联删除
- 永久删除日记时,自动删除其所有附件
- 清空垃圾桶时,批量删除所有日记的附件
- 使用 `@Transactional` 保证数据一致性

#### 2. Java 8 兼容性
- 项目使用 Java 8
- 避免使用 `Stream.toList()` (Java 16+)
- 使用传统 for 循环或 `Collectors.toList()`

#### 3. 附件管理设计
- 附件表只存储图片URL,不涉及文件上传
- 前端可以通过云存储服务(如OSS)上传图片后,将URL保存到数据库
- 支持批量创建和删除操作

### 🔍 验证清单

- [x] 所有实体类字段与数据库设计一致
- [x] AttachmentRepository 接口定义正确
- [x] AttachmentService 业务逻辑完整
- [x] AttachmentController API端点齐全
- [x] DiaryService 级联删除逻辑已添加
- [x] 所有文件无编译错误
- [x] Java 8 兼容性检查通过

### 📝 后续工作建议

#### 1. API 测试
- 测试所有附件相关的API端点
- 测试永久删除日记时的级联删除
- 测试清空垃圾桶时的批量删除

#### 2. 前端集成
- 前端在编辑日记时支持添加图片URL
- 前端显示日记时加载并展示附件图片
- 前端删除日记时提示附件也会被删除

#### 3. 数据库脚本
- 创建 attachments 表的建表SQL
- 如有旧数据,编写数据迁移脚本

#### 4. 文档更新
- 更新 API 文档,添加附件管理相关接口
- 更新部署文档,说明新增的附件表

### 📚 相关文档

- `doc/数据库表设计.md` - 数据库设计文档
- `doc/无用户认证API文档.md` - API文档 (需更新)
- `README.md` - 项目说明 (需更新)

---

**重构完成时间**: 2025-01-XX  
**重构原因**: 简化数据库设计,移除不必要的字段和索引  
**影响范围**: Attachment 实体及相关附件管理功能  
**向后兼容**: 需要数据库迁移


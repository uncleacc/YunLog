# 用户认证系统实现文档

## 一、数据库设计

### 1.1 用户表 (user)
已创建，包含字段：
- id: 用户ID
- username: 用户名（唯一）
- password: BCrypt加密密码
- phone: 手机号（预留）
- wechat_openid: 微信OpenID（唯一）
- wechat_union_id: 微信UnionID（预留）
- nickname: 昵称
- avatar_url: 头像URL
- status: 状态（1-正常 0-禁用）
- create_time/update_time: 时间戳

### 1.2 现有表修改
- diaries表：添加user_id字段
- categories表：添加user_id字段
- attachments表：通过diary_id间接关联用户

## 二、后端实现

### 2.1 核心组件

#### 实体层 (entity/)
- ✅ User.java - 用户实体

#### 仓库层 (repository/)
- ✅ UserRepository.java - 用户数据访问

#### DTO层 (dto/auth/)
需要创建：
- LoginRequest.java - 登录请求（账号密码/微信code）
- RegisterRequest.java - 注册请求
- AuthResponse.java - 认证响应（包含token）
- UserInfoDTO.java - 用户信息DTO

#### 服务层 (service/)
需要创建：
- AuthService.java - 认证服务（登录、注册、token生成）
- WechatService.java - 微信登录服务
- UserService.java - 用户管理服务

#### 工具类 (util/)
需要创建：
- JwtUtil.java - JWT工具类（生成、验证token）
- PasswordUtil.java - 密码加密工具

#### 配置类 (config/)
需要创建：
- SecurityConfig.java - 安全配置
- JwtInterceptor.java - JWT拦截器
- WebConfig.java - Web配置（注册拦截器）

#### 控制器 (controller/)
需要创建：
- AuthController.java - 认证控制器（登录、注册、登出）
- UserController.java - 用户控制器（获取用户信息）

### 2.2 认证流程

#### 账号密码登录
1. 前端提交 username + password
2. 后端验证用户名密码
3. 生成JWT token
4. 返回token和用户信息

#### 微信登录
1. 前端调用wx.login()获取code
2. 前端提交code到后端
3. 后端用code换取openid（调用微信API）
4. 根据openid查找或创建用户
5. 生成JWT token
6. 返回token和用户信息

#### Token验证
1. JWT拦截器拦截所有需要认证的请求
2. 从请求头提取token
3. 验证token有效性
4. 将用户信息存入ThreadLocal（请求上下文）
5. 后续业务逻辑可获取当前登录用户

### 2.3 依赖添加 (pom.xml)
需要添加：
```xml
<!-- JWT -->
<dependency>
    <groupId>io.jsonwebtoken</groupId>
    <artifactId>jjwt-api</artifactId>
    <version>0.11.5</version>
</dependency>
<dependency>
    <groupId>io.jsonwebtoken</groupId>
    <artifactId>jjwt-impl</artifactId>
    <version>0.11.5</version>
</dependency>
<dependency>
    <groupId>io.jsonwebtoken</groupId>
    <artifactId>jjwt-jackson</artifactId>
    <version>0.11.5</version>
</dependency>

<!-- BCrypt密码加密 -->
<dependency>
    <groupId>org.springframework.security</groupId>
    <artifactId>spring-security-crypto</artifactId>
</dependency>

<!-- 微信API调用 -->
<dependency>
    <groupId>org.apache.httpcomponents</groupId>
    <artifactId>httpclient</artifactId>
</dependency>
```

### 2.4 配置文件 (application.yml)
```yaml
jwt:
  secret: your-256-bit-secret-key-change-it-in-production
  expiration: 604800000 # 7天（毫秒）
  
wechat:
  appid: your-wechat-appid
  secret: your-wechat-secret
```

## 三、前端实现

### 3.1 页面
需要创建：
- pages/login/login.vue - 登录页面
  * 支持账号密码登录
  * 支持微信快捷登录
  * 可切换登录方式

### 3.2 工具类修改
- utils/storage.js - 添加token存储方法
- utils/request.js - 请求拦截器自动携带token，401自动跳转登录

### 3.3 API接口
- utils/api.js - 添加认证相关API
  * login(username, password)
  * loginByWechat(code)
  * register(username, password, nickname)
  * getUserInfo()
  * logout()

### 3.4 路由守卫
- 需要登录的页面：edit, category-manage, profile
- 未登录自动跳转login页面

## 四、API接口设计

### 4.1 认证接口
```
POST /api/auth/register       - 注册
POST /api/auth/login          - 账号密码登录
POST /api/auth/login/wechat   - 微信登录
POST /api/auth/logout         - 登出
GET  /api/auth/userinfo       - 获取当前用户信息
```

### 4.2 现有接口修改
所有日记、分类相关接口需要：
1. 添加@RequireLogin注解（通过拦截器实现）
2. 从请求上下文获取当前用户ID
3. 按用户ID过滤数据

## 五、实施步骤

### 第一阶段：后端核心实现（进行中）
1. ✅ 创建User实体和Repository
2. 创建DTO和工具类
3. 实现AuthService和WechatService
4. 创建AuthController
5. 实现JWT拦截器
6. 修改现有Service添加用户隔离

### 第二阶段：前端实现
1. 创建登录页面
2. 修改request.js添加token处理
3. 创建路由守卫
4. 修改个人中心页面

### 第三阶段：测试与优化
1. 测试账号密码登录
2. 测试微信登录
3. 测试数据隔离
4. 测试token过期处理

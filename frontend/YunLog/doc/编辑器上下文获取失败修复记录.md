# 编辑器上下文获取失败修复记录

## 问题描述
编辑日记时出现错误：
```
GetEditorContextWithRetry - 5次尝试后仍无法获取编辑器上下文
```

## 根本原因
在组件拆分后，富文本编辑器 `<editor>` 被移到了 `EditorArea` 子组件中，但父组件 `edit.vue` 仍然试图通过 `uni.createSelectorQuery().select('#editor')` 直接查找编辑器，导致无法找到目标元素。

## 问题分析

### 组件架构变化
**拆分前：**
```vue
<!-- edit.vue -->
<template>
  <editor id="editor" />  <!-- 直接在父组件中 -->
</template>
```

**拆分后：**
```vue
<!-- edit.vue -->
<template>
  <EditorArea />  <!-- 编辑器在子组件中 -->
</template>

<!-- EditorArea.vue -->
<template>
  <editor id="editor" />  <!-- 实际位置在子组件中 -->
</template>
```

### 选择器查询问题
父组件的 `uni.createSelectorQuery().in(this).select('#editor')` 无法跨组件边界找到子组件中的编辑器元素。

## 修复方案

### 1. 将编辑器上下文管理移到 Hook 中
**修改前：**
```javascript
// edit.vue 中的方法
GetEditorContextWithRetry(attempt = 1) {
  uni.createSelectorQuery()
    .in(this)
    .select('#editor')  // ❌ 无法找到子组件中的编辑器
    .context((res) => { ... })
}
```

**修改后：**
```javascript
// useEditorContent.js Hook 中的方法
const getEditorContext = (attempt = 1) => {
  return new Promise((resolve, reject) => {
    uni.createSelectorQuery()
      .select('#editor')  // ✅ 全局查询，可以找到子组件中的编辑器
      .context((res) => { ... })
  })
}
```

### 2. 使用 Promise 化的编辑器初始化
```javascript
const initEditor = async () => {
  try {
    const ctx = await getEditorContext()
    editorCtx.value = ctx
    return ctx
  } catch (error) {
    throw error
  }
}
```

### 3. 修改组件事件处理
```javascript
// 处理编辑器就绪事件
async handleEditorReady(e) {
  this.onEditorReady(e)
  
  if (this.isEditing && this.latestDiary) {
    try {
      await this.initEditor()  // 使用新的 Promise 化方法
      // 编辑器初始化完成后加载内容
    } catch (error) {
      console.error('编辑器初始化失败:', error)
    }
  }
}
```

## 技术要点

### 跨组件元素查询
- **错误方式**: `uni.createSelectorQuery().in(this).select('#editor')`
- **正确方式**: `uni.createSelectorQuery().select('#editor')`

### Promise 化异步操作
- 将回调式的上下文获取改为 Promise，便于使用 async/await
- 统一错误处理和状态管理

### Hook 化状态管理
- 将编辑器相关的状态和方法封装到 `useEditorContent` Hook 中
- 提高代码复用性和可测试性

## 修复结果
✅ 解决编辑器上下文获取失败问题  
✅ 编辑器可以正常初始化  
✅ 编辑模式下可以正确加载日记内容  
✅ 代码结构更加清晰和模块化  

## 经验总结
1. **组件拆分要考虑状态管理**: 跨组件的状态和DOM操作需要重新设计
2. **选择器查询作用域**: `in(this)` 限制查询范围，跨组件时需要全局查询
3. **异步操作 Promise 化**: 便于错误处理和流程控制
4. **Hook 化最佳实践**: 将相关的状态和方法封装到一起

## 相关文件
- `src/pages/edit/hooks/useEditorContent.js` - 新增编辑器上下文管理
- `src/pages/edit/edit.vue` - 修改编辑器初始化逻辑
- `src/pages/edit/components/EditorArea.vue` - 编辑器组件（保持不变）